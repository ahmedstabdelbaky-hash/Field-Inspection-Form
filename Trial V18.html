<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Field Inspection</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    background: white;
    margin: 0;
    padding: 0;
    display: flex;
    justify-content: center;
  }
  #formWrapper {
    width: 210mm;
    padding: 15mm;
    background: white;
    box-sizing: border-box;
  }
  h2 {
    text-align: center;
    margin-bottom: 20px;
    text-transform: uppercase;
  }
  label { font-weight: bold; }
  .section { margin-bottom: 20px; }
  .inline-inputs { display: flex; justify-content: space-between; gap: 10px; }
  input, select {
    width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
  }
  .bullet-box {
    width: 100%; min-height: 80px; border: 1px solid #ccc; border-radius: 4px;
    padding: 6px 10px; box-sizing: border-box; outline: none;
  }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  table, th, td { border: 1px solid #ccc; }
  th, td { padding: 6px; text-align: left; }
  .narrow-input { width: 45%; }
  .buttons { text-align: center; margin-top: 25px; }
  button {
    padding: 10px 20px; margin: 5px; font-weight: bold; border: none; border-radius: 6px;
    cursor: pointer; background-color: #007bff; color: white;
  }
  button:hover { background-color: #0056b3; }
  .clear-btn { background-color: #dc3545; }
  .clear-btn:hover { background-color: #a71d2a; }

  /* --- logos area --- */
  .logos-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    margin-top: 25px;
    gap: 10px;
  }
  .logo-box {
    width: 80px;
    height: 80px;
    border: 2px dashed #aaa;
    border-radius: 6px;
    position: relative;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .logo-box input {
    display: none;
  }
  .add-logo {
    font-size: 32px;
    color: #777;
    cursor: pointer;
    user-select: none;
  }
  .logo-img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }
  .remove-logo {
    position: absolute;
    top: 3px;
    right: 3px;
    background: rgba(0,0,0,0.6);
    color: white;
    border: none;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 14px;
    cursor: pointer;
    display: none;
  }
  /* ❌ تظهر فقط عند الوقوف على الصورة */
  .logo-img:hover + .remove-logo {
    display: block;
  }
</style>
</head>
<body>
<div id="formWrapper">
  <h2>Field Inspection</h2>

  <div id="pdfContent">
    <div class="section inline-inputs">
      <div><label>Contractor's Name:</label><input type="text" id="contractor"></div>
      <div><label>Project Name:</label><input type="text" id="project"></div>
      <div><label>Date:</label><input type="date" id="todayDate"></div>
    </div>

    <div class="section inline-inputs">
      <div><label>Time of Inspection:</label><input type="time" id="time"></div>
      <div>
        <label>Weather:</label>
        <select id="weather">
          <option value="">Select</option>
          <option>Clear</option>
          <option>Rain</option>
          <option>Mist</option>
          <option>Hot</option>
          <option>Cold</option>
          <option>Warm</option>
        </select>
      </div>
    </div>

    <div class="section inline-inputs">
      <div class="narrow-input"><label>Number of Supervisors:</label><input type="number" id="sup" min="0"></div>
      <div class="narrow-input"><label>Number of Skilled Workers:</label><input type="number" id="workers" min="0"></div>
    </div>

    <div class="section">
      <label>Equipments:</label>
      <table>
        <tr><th>Equipment</th><th>Nos</th></tr>
        <tr><td><input list="equipList"></td><td><input type="number" min="0"></td></tr>
        <tr><td><input list="equipList"></td><td><input type="number" min="0"></td></tr>
        <tr><td><input list="equipList"></td><td><input type="number" min="0"></td></tr>
        <tr><td><input list="equipList"></td><td><input type="number" min="0"></td></tr>
      </table>
      <datalist id="equipList">
        <option value="Excavator">
        <option value="Compactor">
        <option value="Truck">
      </datalist>
    </div>

    <div class="section"><label>Location of Inspection:</label><div class="bullet-box" contenteditable="true" id="location"></div></div>
    <div class="section"><label>Work Performed:</label><div class="bullet-box" contenteditable="true" data-bullets="true" id="work"></div></div>
    <div class="section"><label>Comments and Actions:</label><div class="bullet-box" contenteditable="true" data-bullets="true" id="comments"></div></div>
    <div class="section"><label>Issues:</label><div class="bullet-box" contenteditable="true" data-bullets="true" id="issues"></div></div>

    <div class="section narrow-input">
      <label>Inspected By:</label>
      <input type="text" id="inspector">
    </div>

    <!-- Logos section -->
    <div class="logos-container">
      <div class="logo-box"><span class="add-logo" onclick="document.getElementById('logo1').click()">+</span><input type="file" id="logo1" accept="image/*" onchange="previewLogo(event, this)"></div>
      <div class="logo-box"><span class="add-logo" onclick="document.getElementById('logo2').click()">+</span><input type="file" id="logo2" accept="image/*" onchange="previewLogo(event, this)"></div>
      <div class="logo-box"><span class="add-logo" onclick="document.getElementById('logo3').click()">+</span><input type="file" id="logo3" accept="image/*" onchange="previewLogo(event, this)"></div>
      <div class="logo-box"><span class="add-logo" onclick="document.getElementById('logo4').click()">+</span><input type="file" id="logo4" accept="image/*" onchange="previewLogo(event, this)"></div>
      <div class="logo-box"><span class="add-logo" onclick="document.getElementById('logo5').click()">+</span><input type="file" id="logo5" accept="image/*" onchange="previewLogo(event, this)"></div>
    </div>

  </div>

  <div class="buttons">
    <button onclick="savePDF()">Save PDF</button>
    <button class="clear-btn" onclick="clearForm()">Clear</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const today = new Date().toISOString().split("T")[0];
  document.getElementById("todayDate").value = today;
});

document.querySelectorAll('[data-bullets="true"]').forEach(box => {
  box.addEventListener('focus', () => {
    if (box.innerHTML.trim() === '') box.innerHTML = '• ';
  });
  box.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      document.execCommand('insertHTML', false, '<br>• ');
    }
  });
});

function previewLogo(event, input) {
  const box = input.closest('.logo-box');
  const addBtn = box.querySelector('.add-logo');

  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = e => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.classList.add('logo-img');

      const removeBtn = document.createElement('button');
      removeBtn.classList.add('remove-logo');
      removeBtn.innerHTML = '×';
      removeBtn.onclick = () => removeLogo(removeBtn);

      box.appendChild(img);
      box.appendChild(removeBtn);
      addBtn.style.display = 'none';
    };
    reader.readAsDataURL(file);
  }
}

function removeLogo(button) {
  const box = button.closest('.logo-box');
  const addBtn = box.querySelector('.add-logo');
  const input = box.querySelector('input[type="file"]');
  box.querySelectorAll('.logo-img').forEach(img => img.remove());
  button.remove();
  input.value = "";
  addBtn.style.display = 'block';
}

function clearForm() {
  document.querySelectorAll('input, .bullet-box, select').forEach(el => {
    if (el.type === "file") {
      const box = el.closest('.logo-box');
      box.querySelectorAll('.logo-img').forEach(img => img.remove());
      const addBtn = box.querySelector('.add-logo');
      const removeBtn = box.querySelector('.remove-logo');
      if (removeBtn) removeBtn.remove();
      addBtn.style.display = 'block';
      el.value = "";
    } else if (el.tagName === "INPUT") el.value = "";
    else if (el.tagName === "SELECT") el.selectedIndex = 0;
    else el.innerHTML = "";
  });
  document.getElementById("todayDate").value = new Date().toISOString().split("T")[0];
}

async function savePDF() {
  const element = document.getElementById("pdfContent");
  const { jsPDF } = window.jspdf;

  const canvas = await html2canvas(element, { scale: 3, useCORS: true });

  const imgData = canvas.toDataURL("image/jpeg", 0.9);
  const pdf = new jsPDF("p", "mm", "a4");
  const pdfWidth = 210;
  const pdfHeight = 297;

  const imgWidth = pdfWidth - 10;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;
  const finalHeight = imgHeight > pdfHeight - 10 ? pdfHeight - 10 : imgHeight;
  const finalWidth = (canvas.width * finalHeight) / canvas.height;

  const xOffset = (pdfWidth - finalWidth) / 2;
  const yOffset = (pdfHeight - finalHeight) / 2;

  pdf.addImage(imgData, "JPEG", xOffset, yOffset, finalWidth, finalHeight);

  const pdfBlob = pdf.output("blob");
  const dateStr = new Date().toISOString().split("T")[0];
  const fileName = `Field_Inspection_${dateStr}.pdf`;

  if (window.showSaveFilePicker) {
    try {
      const handle = await window.showSaveFilePicker({
        suggestedName: fileName,
        types: [{ description: "PDF Document", accept: { "application/pdf": [".pdf"] } }]
      });
      const writable = await handle.createWritable();
      await writable.write(pdfBlob);
      await writable.close();
      alert("✅ PDF saved successfully!");
      return;
    } catch (err) {
      console.warn("User cancelled or permission denied:", err);
    }
  }

  const link = document.createElement("a");
  link.href = URL.createObjectURL(pdfBlob);
  link.download = fileName;
  link.click();
  URL.revokeObjectURL(link.href);
}
</script>
</body>
</html>
